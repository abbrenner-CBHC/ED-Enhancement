---
title: "CBHC Monthly ED Report"
author: "Allison Brenner"
date: "3/24/2021"
output: 
  html_document:
  theme: flatly
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE )
```



```{r, include=FALSE}
library(janitor)
library(tidyverse)
library(usethis)
library(yaml)
library(lubridate)
library(hrbrthemes)
```

```{r, include=FALSE}
## Import Collective Medical Data from 2020
ed_2020 <- read_csv("raw_data/ED_visits_2020.csv") %>% 
    clean_names()
```



```{r,include=FALSE}
# Drop identifiers
ed_2020_hippa <- 
  ed_2020 %>% 
  select(-first_name, -last_name, -date_of_birth)
```

<center>
## **CCBHC-E ED Cascadia Report**
### **February, 2021**

***
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<div class = "blue">

<center>
Data from Collective Medical were combined with Cascadia EHR data to determine information on emergency department (ED) utilization in February, 2021. Information presented includes Cascadia clients with an ROI for Collective Medical, who utilized the ED at least once from Feb 1-Feb 28, 2021.  
</div>



### SOME STATS ON PAST 30 DAY ED ENCOUNTERS

#### First, compute and display total past month encounters for CBH
### ...in the variable "ed_visit_total"

```{r}
ed_visit_total <- ed_2020_hippa %>% 
  summarise(ed_visit_total = n()) %>% 
  pull(ed_visit_total)
```
There were `r ed_visit_total` total ED visits for CBH clients in 2020.

#### Examine encounters by client

```{r}
ed_2020_hippa %>% 
  group_by(member_id) %>% 
  summarise(ed_visit_total = n()) %>% 
  summarise(mean_ed_visits_per_client = mean(ed_visit_total)) %>% 
  pull(mean_ed_visits_per_client)
```
On average, clients visited the ED `r mean_ed_visits_per_client` times in 2020.

#### Examine encounters by visit facility

```{r}
ed_2020_hippa %>% 
  count(visit_facility) %>% 
  arrange(desc(n))
```



#### Figure 1 displays the total number of ED visits by month in 2020



```{r}
# First, create a month and year variable using lubridate package
ed_visits_by_month <- ed_2020_hippa %>% 
  select(admit_date) %>% 
  mutate(admit_date = mdy_hm(admit_date)) %>% 
  mutate(month = month(admit_date, label = TRUE, abbr = TRUE)) %>% 
  mutate(year = year(admit_date)) %>% 
  select(-admit_date) %>% 
  add_count(year, month)
```

```{r}
ggplot(data=ed_visits_by_month,
        mapping=aes(x=month, y=n)) +
  scale_x_discrete() +
  scale_y_continuous("ED Visits",limits=c(0,900),
                     breaks = seq(0,900, by=100))+
  geom_col()
```

```{r}
# This code improves the quality of the column graph above
ggplot(data=ed_visits_by_month,
        mapping=aes(x=month, y=n, fill=year)) +
  scale_x_discrete() +
  scale_y_continuous(limits=c(0,900),
                     breaks = seq(0,900, by=100))+
  geom_col(show.legend = FALSE) +
  facet_wrap(~year) + 
  geom_text(aes(label= n),
            vjust=-1)+
  labs(title="Total Emergency Department Encounters, 2020 to Date",
       subtitle = "CBH Clients",
       x="Month",
       y="ED Visit Count") +
  theme_ipsum_es()
```






